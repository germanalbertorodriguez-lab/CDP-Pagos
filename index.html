<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pagos CDP</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --azul:    #1a3a5c;
    --azul2:   #2563a8;
    --verde:   #1d7a4e;
    --verde2:  #22c55e;
    --rojo:    #dc2626;
    --amarillo:#d97706;
    --gris0:   #f0f4f8;
    --gris1:   #e2e8f0;
    --gris2:   #94a3b8;
    --gris3:   #64748b;
    --texto:   #0f172a;
    --blanco:  #ffffff;
    --sombra:  0 2px 16px rgba(26,58,92,0.10);
    --sombra2: 0 4px 32px rgba(26,58,92,0.16);
    --radio:   14px;
    --radio-sm:8px;
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html { font-size: 15px; }
  body {
    font-family: 'Sora', sans-serif;
    background: var(--gris0);
    color: var(--texto);
    min-height: 100vh;
  }

  /* â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #login-screen {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #0f2744 0%, #1a3a5c 50%, #0d4f32 100%);
    padding: 24px;
  }
  .login-card {
    background: var(--blanco);
    border-radius: 20px;
    padding: 48px 40px;
    width: 100%;
    max-width: 400px;
    box-shadow: 0 24px 64px rgba(0,0,0,0.30);
    text-align: center;
  }
  .login-logo {
    width: 72px; height: 72px;
    background: linear-gradient(135deg, var(--azul) 0%, var(--verde) 100%);
    border-radius: 18px;
    display: flex; align-items: center; justify-content: center;
    margin: 0 auto 20px;
    font-size: 28px;
    box-shadow: 0 8px 24px rgba(26,58,92,0.3);
  }
  .login-card h1 { font-size: 1.6rem; font-weight: 700; color: var(--azul); margin-bottom: 4px; }
  .login-card p  { font-size: 0.85rem; color: var(--gris3); margin-bottom: 32px; }
  .login-tabs {
    display: flex; gap: 4px;
    background: var(--gris0);
    border-radius: 10px;
    padding: 4px;
    margin-bottom: 28px;
  }
  .login-tab {
    flex: 1; padding: 8px 12px; border: none; border-radius: 7px;
    font-family: 'Sora', sans-serif; font-size: 0.8rem; font-weight: 500;
    cursor: pointer; background: transparent; color: var(--gris3);
    transition: all 0.2s;
  }
  .login-tab.active {
    background: var(--blanco); color: var(--azul);
    box-shadow: 0 1px 6px rgba(0,0,0,0.12); font-weight: 600;
  }
  .form-group { margin-bottom: 16px; text-align: left; }
  .form-group label { display: block; font-size: 0.78rem; font-weight: 600; color: var(--gris3); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.05em; }
  .form-group input, .form-group select {
    width: 100%; padding: 12px 14px;
    border: 1.5px solid var(--gris1);
    border-radius: var(--radio-sm);
    font-family: 'Sora', sans-serif; font-size: 0.92rem;
    color: var(--texto); background: var(--blanco);
    transition: border-color 0.2s, box-shadow 0.2s;
    outline: none;
  }
  .form-group input:focus, .form-group select:focus {
    border-color: var(--azul2);
    box-shadow: 0 0 0 3px rgba(37,99,168,0.12);
  }
  .pin-input {
    font-family: 'JetBrains Mono', monospace !important;
    font-size: 1.4rem !important;
    letter-spacing: 0.3em;
    text-align: center;
  }
  .btn-primary {
    width: 100%; padding: 13px;
    background: linear-gradient(135deg, var(--azul2) 0%, var(--azul) 100%);
    color: var(--blanco); border: none; border-radius: var(--radio-sm);
    font-family: 'Sora', sans-serif; font-size: 0.95rem; font-weight: 600;
    cursor: pointer; transition: all 0.2s;
    box-shadow: 0 4px 12px rgba(37,99,168,0.3);
    margin-top: 4px;
  }
  .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(37,99,168,0.4); }
  .btn-primary:active { transform: translateY(0); }
  .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
  .login-error {
    background: #fef2f2; border: 1px solid #fecaca; color: var(--rojo);
    border-radius: var(--radio-sm); padding: 10px 14px;
    font-size: 0.82rem; margin-top: 12px; display: none;
  }

  /* â”€â”€ APP SHELL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #app { display: none; min-height: 100vh; flex-direction: column; }

  /* Header */
  .header {
    background: linear-gradient(135deg, var(--azul) 0%, #0f2744 100%);
    color: var(--blanco);
    padding: 0 24px;
    height: 60px;
    display: flex; align-items: center; justify-content: space-between;
    position: sticky; top: 0; z-index: 100;
    box-shadow: 0 2px 12px rgba(0,0,0,0.2);
  }
  .header-left { display: flex; align-items: center; gap: 12px; }
  .header-logo {
    width: 36px; height: 36px;
    background: rgba(255,255,255,0.15);
    border-radius: 8px; display: flex; align-items: center; justify-content: center;
    font-size: 16px;
  }
  .header-title { font-size: 1rem; font-weight: 600; }
  .header-equipo { font-size: 0.75rem; opacity: 0.7; }
  .header-right { display: flex; align-items: center; gap: 10px; }
  .badge-role {
    padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.05em;
  }
  .badge-delegado { background: rgba(34,197,94,0.2); color: #86efac; }
  .badge-admin    { background: rgba(251,191,36,0.2); color: #fde68a; }
  .btn-logout {
    background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
    color: var(--blanco); padding: 6px 12px; border-radius: 6px;
    font-family: 'Sora', sans-serif; font-size: 0.75rem; cursor: pointer;
    transition: background 0.2s;
  }
  .btn-logout:hover { background: rgba(255,255,255,0.2); }

  /* Tabs de navegaciÃ³n */
  .nav-tabs {
    background: var(--blanco);
    border-bottom: 1px solid var(--gris1);
    padding: 0 24px;
    display: flex; gap: 0;
    overflow-x: auto;
  }
  .nav-tab {
    padding: 14px 20px; border: none; background: transparent;
    font-family: 'Sora', sans-serif; font-size: 0.85rem; font-weight: 500;
    color: var(--gris3); cursor: pointer;
    border-bottom: 2.5px solid transparent;
    white-space: nowrap; transition: all 0.2s;
  }
  .nav-tab.active { color: var(--azul2); border-bottom-color: var(--azul2); font-weight: 600; }
  .nav-tab:hover:not(.active) { color: var(--azul); }

  /* Content */
  .content { flex: 1; padding: 24px; max-width: 1100px; margin: 0 auto; width: 100%; }

  /* â”€â”€ CARDS & LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .card {
    background: var(--blanco);
    border-radius: var(--radio);
    box-shadow: var(--sombra);
    padding: 24px;
    margin-bottom: 20px;
  }
  .card-title {
    font-size: 1rem; font-weight: 700; color: var(--azul);
    margin-bottom: 16px; display: flex; align-items: center; gap: 8px;
  }

  /* Resumen del equipo (delegado) */
  .equipo-header {
    display: grid; grid-template-columns: 1fr auto;
    gap: 16px; align-items: center;
    background: linear-gradient(135deg, var(--azul) 0%, #0f2744 100%);
    color: var(--blanco); border-radius: var(--radio);
    padding: 24px; margin-bottom: 20px;
  }
  .equipo-nombre { font-size: 1.5rem; font-weight: 700; }
  .equipo-cat    { font-size: 0.8rem; opacity: 0.7; margin-top: 2px; }
  .equipo-stats  { display: flex; gap: 20px; margin-top: 12px; }
  .stat          { text-align: center; }
  .stat-num      { font-size: 1.8rem; font-weight: 700; line-height: 1; }
  .stat-label    { font-size: 0.7rem; opacity: 0.7; margin-top: 2px; }

  /* Selector de mes */
  .mes-selector {
    display: flex; align-items: center; gap: 12px; margin-bottom: 20px;
    flex-wrap: wrap;
  }
  .mes-selector label { font-size: 0.85rem; font-weight: 600; color: var(--gris3); }
  .mes-selector select {
    padding: 8px 14px; border: 1.5px solid var(--gris1);
    border-radius: var(--radio-sm); font-family: 'Sora', sans-serif;
    font-size: 0.85rem; color: var(--texto); outline: none;
    background: var(--blanco); cursor: pointer;
  }
  .mes-selector select:focus { border-color: var(--azul2); }

  /* Tabla de jugadores */
  .tabla-wrapper { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
  thead tr { background: var(--gris0); }
  th {
    padding: 10px 14px; text-align: left; font-weight: 600;
    color: var(--gris3); font-size: 0.75rem; text-transform: uppercase;
    letter-spacing: 0.05em; border-bottom: 1px solid var(--gris1);
    white-space: nowrap;
  }
  td {
    padding: 11px 14px; border-bottom: 1px solid var(--gris0);
    vertical-align: middle;
  }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: #f8fafc; }
  .jugador-nombre { font-weight: 500; }
  .jugador-badges { display: flex; gap: 4px; margin-top: 2px; }
  .badge-mas35 { background: #fef3c7; color: #92400e; font-size: 0.65rem; font-weight: 600; padding: 1px 6px; border-radius: 4px; }
  .badge-ic    { background: #ede9fe; color: #5b21b6; font-size: 0.65rem; font-weight: 600; padding: 1px 6px; border-radius: 4px; }

  /* Estado comprobante */
  .estado-badge {
    display: inline-flex; align-items: center; gap: 5px;
    padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;
    white-space: nowrap;
  }
  .estado-pendiente  { background: #fefce8; color: #a16207; border: 1px solid #fde047; }
  .estado-aprobado   { background: #f0fdf4; color: #15803d; border: 1px solid #86efac; }
  .estado-rechazado  { background: #fef2f2; color: #b91c1c; border: 1px solid #fca5a5; }
  .estado-sin-cargar { background: var(--gris0); color: var(--gris2); border: 1px solid var(--gris1); font-style: italic; }

  /* Botones de acciÃ³n */
  .btn-sm {
    padding: 6px 12px; border-radius: 6px; border: none;
    font-family: 'Sora', sans-serif; font-size: 0.75rem; font-weight: 600;
    cursor: pointer; transition: all 0.15s; white-space: nowrap;
  }
  .btn-cargar    { background: var(--azul2); color: white; }
  .btn-cargar:hover { background: var(--azul); }
  .btn-ver       { background: var(--gris0); color: var(--gris3); border: 1px solid var(--gris1); }
  .btn-ver:hover { background: var(--gris1); }
  .btn-aprobar   { background: #dcfce7; color: var(--verde); border: 1px solid #86efac; }
  .btn-aprobar:hover { background: #bbf7d0; }
  .btn-rechazar  { background: #fee2e2; color: var(--rojo); border: 1px solid #fca5a5; }
  .btn-rechazar:hover { background: #fecaca; }
  .btn-actions   { display: flex; gap: 6px; }

  /* Obs tooltip */
  .obs-icon {
    display: inline-flex; align-items: center; justify-content: center;
    width: 22px; height: 22px; border-radius: 50%;
    background: #fef3c7; color: #d97706;
    font-size: 0.7rem; cursor: pointer; font-weight: 700;
    title: attr(data-obs);
  }

  /* â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(15,23,42,0.6);
    display: flex; align-items: center; justify-content: center;
    z-index: 1000; padding: 20px; display: none;
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--blanco); border-radius: 18px; width: 100%; max-width: 520px;
    box-shadow: 0 24px 64px rgba(0,0,0,0.25); overflow: hidden;
    animation: modalIn 0.25s ease;
  }
  @keyframes modalIn { from { opacity:0; transform: scale(0.95) translateY(10px); } to { opacity:1; transform: none; } }
  .modal-header {
    padding: 20px 24px; border-bottom: 1px solid var(--gris1);
    display: flex; align-items: center; justify-content: space-between;
  }
  .modal-title { font-size: 1rem; font-weight: 700; color: var(--azul); }
  .modal-close {
    width: 30px; height: 30px; border-radius: 8px; border: none;
    background: var(--gris0); color: var(--gris3); font-size: 1.1rem;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    transition: background 0.15s;
  }
  .modal-close:hover { background: var(--gris1); }
  .modal-body { padding: 24px; }
  .modal-footer { padding: 16px 24px; border-top: 1px solid var(--gris1); display: flex; gap: 10px; justify-content: flex-end; }
  .modal-info { background: var(--gris0); border-radius: 10px; padding: 14px; margin-bottom: 16px; }
  .modal-info-row { display: flex; justify-content: space-between; padding: 4px 0; font-size: 0.83rem; }
  .modal-info-row span:first-child { color: var(--gris3); }
  .modal-info-row span:last-child  { font-weight: 600; }

  /* Upload zone */
  .upload-zone {
    border: 2px dashed var(--gris1); border-radius: 12px;
    padding: 32px; text-align: center; cursor: pointer;
    transition: all 0.2s; margin-bottom: 14px;
    position: relative;
  }
  .upload-zone:hover, .upload-zone.drag-over { border-color: var(--azul2); background: #eff6ff; }
  .upload-zone input[type=file] { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
  .upload-icon { font-size: 2rem; margin-bottom: 8px; }
  .upload-text { font-size: 0.85rem; color: var(--gris3); }
  .upload-text strong { color: var(--azul2); }
  .upload-preview {
    display: flex; align-items: center; gap: 10px;
    background: var(--gris0); border-radius: 8px; padding: 10px 14px;
    font-size: 0.82rem; margin-bottom: 14px; display: none;
  }
  .upload-preview .file-icon { font-size: 1.3rem; }
  .upload-preview .file-name { flex: 1; font-weight: 500; }
  .upload-preview .file-size { color: var(--gris3); }
  .upload-preview .remove-file { cursor: pointer; color: var(--rojo); padding: 2px 6px; }
  textarea {
    width: 100%; padding: 10px 12px; border: 1.5px solid var(--gris1);
    border-radius: var(--radio-sm); font-family: 'Sora', sans-serif;
    font-size: 0.85rem; resize: vertical; outline: none;
    transition: border-color 0.2s;
  }
  textarea:focus { border-color: var(--azul2); }
  .obs-rechazado {
    background: #fef2f2; border: 1px solid #fecaca; border-radius: 10px;
    padding: 12px 14px; margin-bottom: 14px;
    font-size: 0.82rem; color: #b91c1c;
  }
  .obs-rechazado strong { display: block; margin-bottom: 4px; }

  /* Preview image in modal */
  .comprobante-preview {
    width: 100%; border-radius: 10px; object-fit: contain;
    max-height: 300px; border: 1px solid var(--gris1);
    margin-bottom: 12px;
  }
  .comprobante-pdf-link {
    display: flex; align-items: center; gap: 8px;
    padding: 12px 16px; background: var(--gris0); border-radius: 10px;
    color: var(--azul2); font-weight: 600; font-size: 0.85rem;
    text-decoration: none; margin-bottom: 12px;
  }

  /* Admin: filtros */
  .filtros {
    display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; align-items: center;
  }
  .filtros select, .filtros input {
    padding: 8px 12px; border: 1.5px solid var(--gris1);
    border-radius: var(--radio-sm); font-family: 'Sora', sans-serif;
    font-size: 0.82rem; outline: none; background: var(--blanco);
  }
  .filtros select:focus, .filtros input:focus { border-color: var(--azul2); }
  .filtro-estado {
    display: flex; gap: 4px;
  }
  .filtro-btn {
    padding: 6px 12px; border-radius: 20px; border: 1.5px solid var(--gris1);
    background: var(--blanco); color: var(--gris3); font-family: 'Sora', sans-serif;
    font-size: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.15s;
  }
  .filtro-btn.active-todos      { background: var(--azul2); color: white; border-color: var(--azul2); }
  .filtro-btn.active-pendiente  { background: #fef3c7; color: #a16207; border-color: #fde047; }
  .filtro-btn.active-aprobado   { background: #dcfce7; color: var(--verde); border-color: #86efac; }
  .filtro-btn.active-rechazado  { background: #fee2e2; color: var(--rojo); border-color: #fca5a5; }

  /* Stats admin */
  .stats-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 14px; margin-bottom: 24px;
  }
  .stat-card {
    background: var(--blanco); border-radius: var(--radio); padding: 18px 20px;
    box-shadow: var(--sombra); border-left: 4px solid var(--gris1);
  }
  .stat-card.azul   { border-left-color: var(--azul2); }
  .stat-card.verde  { border-left-color: var(--verde2); }
  .stat-card.rojo   { border-left-color: var(--rojo); }
  .stat-card.amarillo{ border-left-color: var(--amarillo); }
  .stat-card-num   { font-size: 2rem; font-weight: 700; line-height: 1; }
  .stat-card-label { font-size: 0.75rem; color: var(--gris3); margin-top: 4px; }
  .azul .stat-card-num    { color: var(--azul2); }
  .verde .stat-card-num   { color: var(--verde); }
  .rojo .stat-card-num    { color: var(--rojo); }
  .amarillo .stat-card-num{ color: var(--amarillo); }

  /* Loading */
  .loading {
    display: flex; align-items: center; justify-content: center;
    padding: 60px; color: var(--gris2); font-size: 0.9rem; gap: 10px;
  }
  .spinner {
    width: 20px; height: 20px; border: 2px solid var(--gris1);
    border-top-color: var(--azul2); border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .empty { text-align: center; padding: 48px; color: var(--gris2); font-size: 0.9rem; }
  .empty-icon { font-size: 2.5rem; margin-bottom: 10px; }

  /* Toast */
  .toast {
    position: fixed; bottom: 24px; right: 24px; z-index: 2000;
    padding: 12px 20px; border-radius: 10px; font-size: 0.85rem; font-weight: 500;
    box-shadow: 0 8px 24px rgba(0,0,0,0.15); transform: translateX(120%);
    transition: transform 0.3s ease; max-width: 360px;
    display: flex; align-items: center; gap: 10px;
  }
  .toast.show { transform: none; }
  .toast.success { background: #f0fdf4; color: #15803d; border: 1px solid #86efac; }
  .toast.error   { background: #fef2f2; color: #b91c1c; border: 1px solid #fca5a5; }
  .toast.info    { background: #eff6ff; color: var(--azul2); border: 1px solid #bfdbfe; }

  /* Responsive */
  @media (max-width: 640px) {
    .content { padding: 16px; }
    .login-card { padding: 32px 24px; }
    .equipo-stats { gap: 12px; }
    .filtros { gap: 8px; }
    th, td { padding: 8px 10px; }
  }

  /* Pagination */
  .pagination { display: flex; gap: 4px; justify-content: center; margin-top: 16px; }
  .page-btn {
    width: 34px; height: 34px; border-radius: 8px; border: 1.5px solid var(--gris1);
    background: var(--blanco); color: var(--gris3); font-family: 'Sora',sans-serif;
    font-size: 0.82rem; cursor: pointer; transition: all 0.15s;
    display: flex; align-items: center; justify-content: center;
  }
  .page-btn.active { background: var(--azul2); color: white; border-color: var(--azul2); }
  .page-btn:hover:not(.active) { border-color: var(--azul2); color: var(--azul2); }

  /* Obs-tag en tabla */
  .obs-tag {
    max-width: 180px; overflow: hidden; text-overflow: ellipsis;
    white-space: nowrap; font-size: 0.75rem; color: var(--rojo);
    cursor: help;
  }

  /* â”€â”€ PLANILLAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .partido-card {
    background: var(--blanco); border-radius: var(--radio);
    box-shadow: var(--sombra); padding: 18px 20px;
    margin-bottom: 12px; display: flex;
    align-items: center; justify-content: space-between;
    gap: 16px; flex-wrap: wrap;
    transition: box-shadow 0.2s;
  }
  .partido-card:hover { box-shadow: var(--sombra2); }
  .partido-info { flex: 1; min-width: 200px; }
  .partido-titulo { font-weight: 700; font-size: 0.95rem; color: var(--azul); }
  .partido-detalle { font-size: 0.78rem; color: var(--gris3); margin-top: 3px; }
  .partido-detalle span { margin-right: 12px; }
  .partido-cat { font-size: 0.7rem; font-weight: 600; padding: 2px 8px; border-radius: 20px; }
  .cat-libres { background: #dbeafe; color: #1d4ed8; }
  .cat-senior { background: #fef3c7; color: #92400e; }
  .btn-planilla {
    padding: 8px 16px; background: var(--azul); color: white;
    border: none; border-radius: var(--radio-sm);
    font-family: 'Sora', sans-serif; font-size: 0.8rem; font-weight: 600;
    cursor: pointer; white-space: nowrap; transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(26,58,92,0.2);
  }
  .btn-planilla:hover { background: var(--azul2); transform: translateY(-1px); }
  .btn-planilla:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
  .fixture-filtros { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
  .fixture-filtros select {
    padding: 8px 12px; border: 1.5px solid var(--gris1);
    border-radius: var(--radio-sm); font-family: 'Sora', sans-serif;
    font-size: 0.82rem; outline: none; background: var(--blanco);
    cursor: pointer;
  }
  .fixture-filtros select:focus { border-color: var(--azul2); }
  .fixture-grupo-titulo {
    font-size: 0.75rem; font-weight: 700; text-transform: uppercase;
    letter-spacing: 0.08em; color: var(--gris3);
    margin: 20px 0 10px; padding-bottom: 6px;
    border-bottom: 1px solid var(--gris1);
  }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â• LOGIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="login-screen">
  <div class="login-card">
    <div class="login-logo">âš½</div>
    <h1>Pagos CDP</h1>
    <p>Club de Profesionales Â· Sistema de Comprobantes</p>

    <div class="login-tabs">
      <button class="login-tab active" onclick="setLoginMode('delegado')">Delegado</button>
      <button class="login-tab" onclick="setLoginMode('admin')">Administrador</button>
    </div>

    <!-- Delegado -->
    <div id="form-delegado">
      <div class="form-group">
        <label>Equipo</label>
        <select id="login-equipo">
          <option value="">SeleccionÃ¡ tu equipo...</option>
        </select>
      </div>
      <div class="form-group">
        <label>PIN de acceso</label>
        <input type="password" id="login-pin" class="pin-input" placeholder="â€¢â€¢â€¢â€¢" maxlength="8" onkeydown="if(event.key==='Enter') doLogin()">
      </div>
      <button class="btn-primary" onclick="doLogin()" id="btn-login">Ingresar</button>
    </div>

    <!-- Admin -->
    <div id="form-admin" style="display:none">
      <div class="form-group">
        <label>PIN de administrador</label>
        <input type="password" id="admin-pin" class="pin-input" placeholder="â€¢â€¢â€¢â€¢" maxlength="8" onkeydown="if(event.key==='Enter') doAdminLogin()">
      </div>
      <button class="btn-primary" onclick="doAdminLogin()" id="btn-admin-login">Ingresar como Admin</button>
    </div>

    <div class="login-error" id="login-error"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â• APP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="app" style="display:none; flex-direction:column; min-height:100vh;">

  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <div class="header-logo">âš½</div>
      <div>
        <div class="header-title">Pagos CDP</div>
        <div class="header-equipo" id="header-subtitulo">Club de Profesionales</div>
      </div>
    </div>
    <div class="header-right">
      <span class="badge-role" id="badge-role">Delegado</span>
      <button class="btn-logout" onclick="doLogout()">Salir</button>
    </div>
  </div>

  <!-- Nav tabs -->
  <div class="nav-tabs" id="nav-tabs">
    <!-- se llenan segÃºn el rol -->
  </div>

  <!-- Contenido -->
  <div class="content" id="main-content">
    <div class="loading"><div class="spinner"></div> Cargando...</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â• MODAL CARGAR COMPROBANTE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="modal-cargar">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title" id="modal-cargar-title">Cargar Comprobante</span>
      <button class="modal-close" onclick="cerrarModal('modal-cargar')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="modal-info">
        <div class="modal-info-row"><span>Jugador</span><span id="mc-jugador">â€”</span></div>
        <div class="modal-info-row"><span>Equipo</span><span id="mc-equipo">â€”</span></div>
        <div class="modal-info-row"><span>Mes</span><span id="mc-mes">â€”</span></div>
      </div>
      <div class="obs-rechazado" id="obs-rechazo-prev" style="display:none">
        <strong>âš ï¸ Fue rechazado por:</strong>
        <span id="obs-rechazo-texto"></span>
      </div>
      <div class="upload-zone" id="upload-zone">
        <input type="file" id="file-input" accept="image/*,.pdf" onchange="handleFile(this)">
        <div class="upload-icon">ğŸ“</div>
        <div class="upload-text">
          <strong>ArrastrÃ¡ o hacÃ© clic</strong> para seleccionar el comprobante<br>
          <span style="font-size:0.75rem; color:var(--gris2)">JPG, PNG o PDF Â· MÃ¡x 10MB</span>
        </div>
      </div>
      <div class="upload-preview" id="upload-preview">
        <span class="file-icon" id="prev-icon">ğŸ“„</span>
        <span class="file-name" id="prev-name"></span>
        <span class="file-size" id="prev-size"></span>
        <span class="remove-file" onclick="removeFile()">âœ•</span>
      </div>
      <div class="form-group">
        <label>ObservaciÃ³n (opcional)</label>
        <textarea id="mc-obs" rows="3" placeholder="PodÃ©s agregar una aclaraciÃ³n..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-sm btn-ver" onclick="cerrarModal('modal-cargar')">Cancelar</button>
      <button class="btn-sm btn-cargar" id="btn-confirmar-carga" onclick="confirmarCarga()">Cargar comprobante</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â• MODAL VER COMPROBANTE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="modal-ver">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title">Ver Comprobante</span>
      <button class="modal-close" onclick="cerrarModal('modal-ver')">âœ•</button>
    </div>
    <div class="modal-body" id="modal-ver-body">
    </div>
    <div class="modal-footer" id="modal-ver-footer">
      <button class="btn-sm btn-ver" onclick="cerrarModal('modal-ver')">Cerrar</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â• MODAL RECHAZAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="modal-rechazar">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title">Rechazar Comprobante</span>
      <button class="modal-close" onclick="cerrarModal('modal-rechazar')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="modal-info">
        <div class="modal-info-row"><span>Jugador</span><span id="rech-jugador">â€”</span></div>
        <div class="modal-info-row"><span>Mes</span><span id="rech-mes">â€”</span></div>
        <div class="modal-info-row"><span>Equipo</span><span id="rech-equipo">â€”</span></div>
      </div>
      <div class="form-group">
        <label>Motivo del rechazo *</label>
        <textarea id="rech-obs" rows="4" placeholder="IndicÃ¡ por quÃ© se rechaza el comprobante..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-sm btn-ver" onclick="cerrarModal('modal-rechazar')">Cancelar</button>
      <button class="btn-sm btn-rechazar" onclick="confirmarRechazo()">Rechazar</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â• TOAST â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIGURACIÃ“N  â†  COMPLETAR CON TUS DATOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CONFIG = {
  // URL de tu Google Apps Script Web App (la pegÃ¡s despuÃ©s de publicar)
  SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbyO6SflHmEbETz3OStOxkFiZom5dTbJJQ5oU9unGu3lkVsNEYW7uNEpimRE2mTfEtS5/exec',


  // PIN del administrador (podÃ©s cambiarlo en el script tambiÃ©n)
  ADMIN_PIN: '1603',

  // Meses habilitados para carga
  MESES: ['Enero','Febrero','Marzo','Abril','Mayo','Junio',
          'Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'],

  // Mes activo por defecto (el actual)
  MES_ACTUAL: 'Febrero'
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ESTADO GLOBAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let APP = {
  rol: null,            // 'delegado' | 'admin'
  equipo: null,         // objeto equipo del delegado
  equipos: [],          // todos los equipos
  jugadores: [],        // jugadores del equipo actual (delegado)
  comprobantes: [],     // comprobantes cargados
  mesSeleccionado: CONFIG.MES_ACTUAL,
  paginaActual: 1,
  porPagina: 25,
  filtroEstado: 'todos',
  filtroEquipo: '',
  filtroMes: CONFIG.MES_ACTUAL,
  // datos modal
  modalJugadorId: null,
  modalJugadorNombre: null,
  modalComprobanteId: null,
  archivoSeleccionado: null,
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EQUIPOS HARDCODED (fallback mientras se carga del sheet)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const EQUIPOS_FALLBACK = [
  {id:'Abogados_A',       nombre:'Abogados A',        cat:'Libres',  pin:''},
  {id:'Abogados_AR',      nombre:'Abogados AR',        cat:'Libres',  pin:''},
  {id:'Abogados_B',       nombre:'Abogados B',         cat:'Libres',  pin:''},
  {id:'Arquitectos',      nombre:'Arquitectos',        cat:'Libres',  pin:''},
  {id:'Contadores_A',     nombre:'Contadores A',       cat:'Libres',  pin:''},
  {id:'Contadores_Z',     nombre:'Contadores Z',       cat:'Libres',  pin:''},
  {id:'Docentes_A',       nombre:'Docentes A',         cat:'Libres',  pin:''},
  {id:'Docentes_B',       nombre:'Docentes B',         cat:'Libres',  pin:''},
  {id:'Docentes_E',       nombre:'Docentes E',         cat:'Libres',  pin:''},
  {id:'Docentes_W',       nombre:'Docentes W',         cat:'Libres',  pin:''},
  {id:'Ingenieros',       nombre:'Ingenieros',         cat:'Libres',  pin:''},
  {id:'Ingenieros_S',     nombre:'Ingenieros S',       cat:'Libres',  pin:''},
  {id:'Maestros',         nombre:'Maestros',           cat:'Libres',  pin:''},
  {id:'Profesores_P',     nombre:'Profesores P',       cat:'Libres',  pin:''},
  {id:'Salud_B',          nombre:'Salud B',            cat:'Libres',  pin:''},
  {id:'Salud_F',          nombre:'Salud F',            cat:'Libres',  pin:''},
  {id:'Salud_T',          nombre:'Salud T',            cat:'Libres',  pin:''},
  {id:'Tecnicos_A',       nombre:'Tecnicos A',         cat:'Libres',  pin:''},
  {id:'Abogados_A_(S)',   nombre:'Abogados A (S)',     cat:'Senior',  pin:''},
  {id:'Arquitectos_(S)',  nombre:'Arquitectos (S)',    cat:'Senior',  pin:''},
  {id:'Contadores_A_(S)', nombre:'Contadores A (S)',   cat:'Senior',  pin:''},
  {id:'Contadores_Z_(S)', nombre:'Contadores Z (S)',   cat:'Senior',  pin:''},
  {id:'Docentes_A_(S)',   nombre:'Docentes A (S)',     cat:'Senior',  pin:''},
  {id:'Docentes_B_(S)',   nombre:'Docentes B (S)',     cat:'Senior',  pin:''},
  {id:'Docentes_F_(S)',   nombre:'Docentes F (S)',     cat:'Senior',  pin:''},
  {id:'Docentes_T_(S)',   nombre:'Docentes T (S)',     cat:'Senior',  pin:''},
  {id:'Docentes_X_(S)',   nombre:'Docentes X (S)',     cat:'Senior',  pin:''},
  {id:'Licenciados_(S)',  nombre:'Licenciados (S)',    cat:'Senior',  pin:''},
  {id:'Salud_B_(S)',      nombre:'Salud B (S)',        cat:'Senior',  pin:''},
  {id:'Salud_F_(S)',      nombre:'Salud F (S)',        cat:'Senior',  pin:''},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function api(accion, datos = {}) {
  const params = new URLSearchParams({ accion, ...datos });
  const res = await fetch(CONFIG.SCRIPT_URL + '?' + params.toString());
  if (!res.ok) throw new Error('Error de red');
  return res.json();
}

async function apiPost(accion, datos = {}) {
  const fd = new FormData();
  fd.append('accion', accion);
  for (const [k, v] of Object.entries(datos)) {
    fd.append(k, v);
  }
  const res = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: fd });
  if (!res.ok) throw new Error('Error de red');
  return res.json();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOGIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let loginMode = 'delegado';

function setLoginMode(modo) {
  loginMode = modo;
  document.querySelectorAll('.login-tab').forEach((t,i) => t.classList.toggle('active', i===(modo==='delegado'?0:1)));
  document.getElementById('form-delegado').style.display = modo==='delegado' ? '' : 'none';
  document.getElementById('form-admin').style.display    = modo==='admin'    ? '' : 'none';
  document.getElementById('login-error').style.display  = 'none';
}

async function cargarEquiposSelect() {
  const sel = document.getElementById('login-equipo');
  sel.innerHTML = '<option value="">SeleccionÃ¡ tu equipo...</option>';

  // Agrupar por categorÃ­a
  const libres = EQUIPOS_FALLBACK.filter(e => e.cat === 'Libres');
  const senior = EQUIPOS_FALLBACK.filter(e => e.cat === 'Senior');

  const addGroup = (label, arr) => {
    const og = document.createElement('optgroup');
    og.label = label;
    arr.forEach(e => {
      const o = document.createElement('option');
      o.value = e.id; o.textContent = e.nombre;
      og.appendChild(o);
    });
    sel.appendChild(og);
  };
  addGroup('â”€â”€ Libres â”€â”€', libres);
  addGroup('â”€â”€ Senior â”€â”€', senior);

  // Intentar cargar PINs del sheet
  try {
    const data = await api('getEquipos');
    if (data.ok) {
      APP.equipos = data.equipos;
      // Actualizar pins en el select sin cambiar opciones
    }
  } catch(e) {
    // Usa fallback local
    APP.equipos = EQUIPOS_FALLBACK;
  }
}

async function doLogin() {
  const equipoId = document.getElementById('login-equipo').value;
  const pin      = document.getElementById('login-pin').value.trim();
  const err      = document.getElementById('login-error');
  const btn      = document.getElementById('btn-login');

  if (!equipoId) { showError(err, 'SeleccionÃ¡ un equipo.'); return; }
  if (!pin)      { showError(err, 'IngresÃ¡ tu PIN.'); return; }

  btn.disabled = true; btn.textContent = 'Verificando...';

  try {
    const data = await api('login', { equipoId, pin });
    if (data.ok) {
      APP.rol = 'delegado';
      APP.equipo = data.equipo;
      iniciarApp();
    } else {
      showError(err, data.msg || 'PIN incorrecto.');
    }
  } catch(e) {
    showError(err, 'No se pudo conectar. RevisÃ¡ la URL del script.');
  }
  btn.disabled = false; btn.textContent = 'Ingresar';
}

async function doAdminLogin() {
  const pin = document.getElementById('admin-pin').value.trim();
  const err = document.getElementById('login-error');
  const btn = document.getElementById('btn-admin-login');

  if (!pin) { showError(err, 'IngresÃ¡ el PIN de administrador.'); return; }

  btn.disabled = true; btn.textContent = 'Verificando...';

  try {
    const data = await api('loginAdmin', { pin });
    if (data.ok) {
      APP.rol = 'admin';
      iniciarApp();
    } else {
      showError(err, 'PIN de administrador incorrecto.');
    }
  } catch(e) {
    showError(err, 'No se pudo conectar.');
  }
  btn.disabled = false; btn.textContent = 'Ingresar como Admin';
}

function showError(el, msg) {
  el.style.display = 'block'; el.textContent = msg;
}

function doLogout() {
  APP = { rol:null, equipo:null, equipos:EQUIPOS_FALLBACK, jugadores:[], comprobantes:[],
    mesSeleccionado:CONFIG.MES_ACTUAL, paginaActual:1, porPagina:25,
    filtroEstado:'todos', filtroEquipo:'', filtroMes:CONFIG.MES_ACTUAL,
    modalJugadorId:null, modalJugadorNombre:null, modalComprobanteId:null, archivoSeleccionado:null
  };
  document.getElementById('app').style.display = 'none';
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('login-pin').value = '';
  document.getElementById('admin-pin').value = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INICIO DE APP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function iniciarApp() {
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('app').style.display = 'flex';

  // Header
  document.getElementById('header-subtitulo').textContent =
    APP.rol === 'admin' ? 'Panel de AdministraciÃ³n' : APP.equipo.nombre;
  const badge = document.getElementById('badge-role');
  badge.textContent = APP.rol === 'admin' ? 'Admin' : 'Delegado';
  badge.className = 'badge-role ' + (APP.rol === 'admin' ? 'badge-admin' : 'badge-delegado');

  // Tabs
  const tabs = document.getElementById('nav-tabs');
  if (APP.rol === 'delegado') {
    tabs.innerHTML = `
      <button class="nav-tab active" onclick="navTo('mis-comprobantes', this)">ğŸ“‹ Mis Comprobantes</button>
      <button class="nav-tab" onclick="navTo('habilitaciones', this)">ğŸ… Habilitaciones</button>
      <button class="nav-tab" onclick="navTo('historial', this)">ğŸ“‚ Historial</button>
    `;
    renderDelegado();
  } else {
    tabs.innerHTML = `
      <button class="nav-tab active" onclick="navTo('panel-admin', this)">ğŸ“Š Panel</button>
      <button class="nav-tab" onclick="navTo('todos-comprobantes', this)">ğŸ“‹ Comprobantes</button>
      <button class="nav-tab" onclick="navTo('por-equipo', this)">âš½ Por Equipo</button>
      <button class="nav-tab" onclick="navTo('jugadores-admin', this)">ğŸ‘¥ Jugadores</button>
      <button class="nav-tab" onclick="navTo('planillas', this)">ğŸ“„ Planillas</button>
    `;
    renderAdmin();
  }
}

function navTo(vista, btn) {
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  if (btn) btn.classList.add('active');
  if (vista === 'mis-comprobantes' || vista === 'historial') {
    renderDelegado(vista);
  } else if (vista === 'habilitaciones') {
    renderHabilitaciones();
  } else if (vista === 'panel-admin') {
    renderAdmin();
  } else if (vista === 'todos-comprobantes') {
    renderTodosComprobantes();
  } else if (vista === 'por-equipo') {
    renderPorEquipo();
  } else if (vista === 'jugadores-admin') {
    renderGestionJugadores();
  } else if (vista === 'planillas') {
    renderPlanillas();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VISTA DELEGADO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderDelegado(vista = 'mis-comprobantes') {
  const cnt = document.getElementById('main-content');
  cnt.innerHTML = '<div class="loading"><div class="spinner"></div> Cargando jugadores...</div>';

  try {
    const data = await api('getJugadores', { equipoId: APP.equipo.id });
    if (!data.ok) throw new Error(data.msg);
    APP.jugadores = data.jugadores;

    const dataC = await api('getComprobantes', { equipoId: APP.equipo.id });
    APP.comprobantes = dataC.ok ? dataC.comprobantes : [];

    if (vista === 'historial') {
      renderHistorial(cnt);
    } else {
      renderMisComprobantes(cnt);
    }
  } catch(e) {
    cnt.innerHTML = `<div class="empty"><div class="empty-icon">âš ï¸</div>Error al cargar: ${e.message}</div>`;
  }
}

function renderMisComprobantes(cnt) {
  const eq = APP.equipo;
  const jug = APP.jugadores;
  const comp = APP.comprobantes.filter(c => c.estado !== 'Reemplazado'); // Ignorar reemplazados
  const mes = APP.mesSeleccionado;

  // Para cada jugador+mes, quedarse con el comprobante mÃ¡s reciente activo
  function getCompActivo(jugadorId, mes) {
    const del = comp.filter(c => String(c.jugadorId) == String(jugadorId) && c.mes === mes);
    if (!del.length) return null;
    // Prioridad: Aprobado > Pendiente > Rechazado (mÃ¡s reciente)
    del.sort((a,b) => {
      const ord = {Aprobado:0,Pendiente:1,Rechazado:2};
      return (ord[a.estado]||9) - (ord[b.estado]||9) || new Date(b.fecha) - new Date(a.fecha);
    });
    return del[0];
  }

  const compActivos = jug.map(j => getCompActivo(j.id, mes));
  const aprobados   = compActivos.filter(c => c?.estado === 'Aprobado').length;
  const pendientes  = compActivos.filter(c => c?.estado === 'Pendiente').length;
  const rechazados  = compActivos.filter(c => c?.estado === 'Rechazado').length;

  cnt.innerHTML = `
    <div class="equipo-header">
      <div>
        <div class="equipo-nombre">${eq.nombre}</div>
        <div class="equipo-cat">${eq.cat || ''}</div>
        <div class="equipo-stats">
          <div class="stat"><div class="stat-num">${jug.length}</div><div class="stat-label">Jugadores</div></div>
          <div class="stat"><div class="stat-num" style="color:#86efac">${aprobados}</div><div class="stat-label">Aprobados</div></div>
          <div class="stat"><div class="stat-num" style="color:#fde047">${pendientes}</div><div class="stat-label">Pendientes</div></div>
          <div class="stat"><div class="stat-num" style="color:#fca5a5">${rechazados}</div><div class="stat-label">Rechazados</div></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="mes-selector">
        <label>Mes a visualizar:</label>
        <select onchange="APP.mesSeleccionado=this.value; renderMisComprobantes(document.getElementById('main-content'))">
          ${CONFIG.MESES.map(m => `<option ${m===mes?'selected':''}>${m}</option>`).join('')}
        </select>
      </div>
      <div class="tabla-wrapper">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Jugador</th>
              <th>Estado</th>
              <th>ObservaciÃ³n</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            ${jug.map((j, i) => {
              const c = getCompActivo(j.id, mes);
              return renderFilaDelegado(i+1, j, c, mes);
            }).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

function renderFilaDelegado(i, jugador, comp, mes) {
  let estadoHtml = `<span class="estado-badge estado-sin-cargar">Sin cargar</span>`;
  let accionHtml = `<button class="btn-sm btn-cargar" onclick="abrirModalCargar(${jugador.id},'${jugador.nombre.replace(/'/g,"\\'")}','${mes}',null,null)">ğŸ“¤ Cargar</button>`;

  if (comp) {
    if (comp.estado === 'Aprobado') {
      estadoHtml = `<span class="estado-badge estado-aprobado">âœ… Aprobado</span>`;
      accionHtml = `<button class="btn-sm btn-ver" onclick="abrirModalVer('${comp.id}')">ğŸ‘ Ver</button>`;
    } else if (comp.estado === 'Rechazado') {
      estadoHtml = `<span class="estado-badge estado-rechazado">âŒ Rechazado</span>`;
      accionHtml = `
        <div class="btn-actions">
          <button class="btn-sm btn-ver" onclick="abrirModalVer('${comp.id}')">ğŸ‘ Ver</button>
          <button class="btn-sm btn-cargar" onclick="abrirModalCargar(${jugador.id},'${jugador.nombre.replace(/'/g,"\\'")}','${mes}','${comp.id}','${(comp.obsAdmin||'').replace(/'/g,"\\'")}')">ğŸ”„ Reintentar</button>
        </div>`;
    } else {
      estadoHtml = `<span class="estado-badge estado-pendiente">â³ Pendiente</span>`;
      accionHtml = `<button class="btn-sm btn-ver" onclick="abrirModalVer('${comp.id}')">ğŸ‘ Ver</button>`;
    }
  }

  const obsHtml = comp?.obsAdmin
    ? `<span class="obs-tag" title="${comp.obsAdmin}">${comp.obsAdmin}</span>`
    : 'â€”';

  const badges = [
    jugador.mas35 ? '<span class="badge-mas35">+35</span>' : '',
    jugador.ic    ? '<span class="badge-ic">IC</span>' : ''
  ].join('');

  return `
    <tr>
      <td style="color:var(--gris2); font-size:0.75rem; font-family:'JetBrains Mono',monospace">${String(i).padStart(2,'0')}</td>
      <td>
        <div class="jugador-nombre">${jugador.nombre}</div>
        ${badges ? `<div class="jugador-badges">${badges}</div>` : ''}
      </td>
      <td>${estadoHtml}</td>
      <td>${obsHtml}</td>
      <td>${accionHtml}</td>
    </tr>`;
}

function renderHistorial(cnt) {
  const comp = [...APP.comprobantes].sort((a,b) => new Date(b.fecha)-new Date(a.fecha));
  cnt.innerHTML = `
    <div class="card">
      <div class="card-title">ğŸ“‚ Historial completo â€” ${APP.equipo.nombre}</div>
      ${comp.length === 0
        ? '<div class="empty"><div class="empty-icon">ğŸ“‚</div>No hay comprobantes cargados.</div>'
        : `<div class="tabla-wrapper">
          <table>
            <thead><tr><th>Jugador</th><th>Mes</th><th>Estado</th><th>Fecha carga</th><th>ObservaciÃ³n</th><th></th></tr></thead>
            <tbody>
              ${comp.map(c => `
                <tr>
                  <td class="jugador-nombre">${c.jugadorNombre}</td>
                  <td>${c.mes}</td>
                  <td>${estadoBadge(c.estado)}</td>
                  <td style="font-size:0.78rem;color:var(--gris3)">${formatFecha(c.fecha)}</td>
                  <td>${c.obsAdmin ? `<span class="obs-tag" title="${c.obsAdmin}">${c.obsAdmin}</span>` : 'â€”'}</td>
                  <td><button class="btn-sm btn-ver" onclick="abrirModalVer('${c.id}')">ğŸ‘</button></td>
                </tr>`).join('')}
            </tbody>
          </table>
        </div>`}
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VISTA ADMIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderAdmin() {
  const cnt = document.getElementById('main-content');
  cnt.innerHTML = '<div class="loading"><div class="spinner"></div> Cargando datos...</div>';

  try {
    const data = await api('getResumen');
    if (!data.ok) throw new Error(data.msg);

    const { total, aprobados, pendientes, rechazados, porEquipo } = data;
    cnt.innerHTML = `
      <div class="stats-grid">
        <div class="stat-card azul"><div class="stat-card-num">${total}</div><div class="stat-card-label">Total comprobantes</div></div>
        <div class="stat-card verde"><div class="stat-card-num">${aprobados}</div><div class="stat-card-label">Aprobados</div></div>
        <div class="stat-card amarillo"><div class="stat-card-num">${pendientes}</div><div class="stat-card-label">Pendientes</div></div>
        <div class="stat-card rojo"><div class="stat-card-num">${rechazados}</div><div class="stat-card-label">Rechazados</div></div>
      </div>
      <div class="card">
        <div class="card-title">âš½ Resumen por equipo â€” ${APP.filtroMes}</div>
        <div class="mes-selector" style="margin-bottom:14px">
          <label>Mes:</label>
          <select onchange="APP.filtroMes=this.value; renderAdmin()">
            ${CONFIG.MESES.map(m=>`<option ${m===APP.filtroMes?'selected':''}>${m}</option>`).join('')}
          </select>
        </div>
        <div class="tabla-wrapper">
          <table>
            <thead><tr><th>Equipo</th><th>CategorÃ­a</th><th>Jugadores</th><th>Aprobados</th><th>Pendientes</th><th>Rechazados</th><th>Sin cargar</th></tr></thead>
            <tbody>
              ${(porEquipo||[]).map(e=>`
                <tr>
                  <td class="jugador-nombre">${e.nombre}</td>
                  <td style="font-size:0.78rem;color:var(--gris3)">${e.cat}</td>
                  <td style="text-align:center">${e.total}</td>
                  <td style="text-align:center;color:var(--verde);font-weight:600">${e.aprobados}</td>
                  <td style="text-align:center;color:var(--amarillo);font-weight:600">${e.pendientes}</td>
                  <td style="text-align:center;color:var(--rojo);font-weight:600">${e.rechazados}</td>
                  <td style="text-align:center;color:var(--gris2)">${e.total - e.aprobados - e.pendientes - e.rechazados}</td>
                </tr>`).join('')}
            </tbody>
          </table>
        </div>
      </div>`;
  } catch(e) {
    cnt.innerHTML = `<div class="empty"><div class="empty-icon">âš ï¸</div>Error: ${e.message}</div>`;
  }
}

async function renderTodosComprobantes() {
  const cnt = document.getElementById('main-content');
  cnt.innerHTML = '<div class="loading"><div class="spinner"></div> Cargando comprobantes...</div>';

  try {
    const data = await api('getAllComprobantes', {
      mes: APP.filtroMes,
      estado: APP.filtroEstado,
      equipoId: APP.filtroEquipo
    });
    if (!data.ok) throw new Error(data.msg);
    APP.comprobantes = data.comprobantes;
    renderListaAdmin(cnt);
  } catch(e) {
    cnt.innerHTML = `<div class="empty"><div class="empty-icon">âš ï¸</div>Error: ${e.message}</div>`;
  }
}

function renderListaAdmin(cnt) {
  const comp = APP.comprobantes;
  const inicio = (APP.paginaActual - 1) * APP.porPagina;
  const pagina = comp.slice(inicio, inicio + APP.porPagina);

  cnt.innerHTML = `
    <div class="card">
      <div class="card-title">ğŸ“‹ Comprobantes</div>
      <div class="filtros">
        <select onchange="APP.filtroMes=this.value; APP.paginaActual=1; renderTodosComprobantes()">
          <option value="">Todos los meses</option>
          ${CONFIG.MESES.map(m=>`<option ${m===APP.filtroMes?'selected':''}>${m}</option>`).join('')}
        </select>
        <select onchange="APP.filtroEquipo=this.value; APP.paginaActual=1; renderTodosComprobantes()">
          <option value="">Todos los equipos</option>
          ${EQUIPOS_FALLBACK.map(e=>`<option value="${e.id}" ${e.id===APP.filtroEquipo?'selected':''}>${e.nombre}</option>`).join('')}
        </select>
        <div class="filtro-estado">
          ${['todos','Pendiente','Aprobado','Rechazado'].map(e=>`
            <button class="filtro-btn ${APP.filtroEstado===e?'active-'+e.toLowerCase():''}"
              onclick="APP.filtroEstado='${e}'; APP.paginaActual=1; renderTodosComprobantes()">
              ${e==='todos'?'Todos':e}
            </button>`).join('')}
        </div>
      </div>
      ${comp.length === 0
        ? '<div class="empty"><div class="empty-icon">ğŸ“‹</div>No hay comprobantes con esos filtros.</div>'
        : `<div class="tabla-wrapper">
          <table>
            <thead><tr><th>Equipo</th><th>Jugador</th><th>Mes</th><th>Fecha</th><th>Estado</th><th>ObservaciÃ³n</th><th>Acciones</th></tr></thead>
            <tbody>
              ${pagina.map(c=>`
                <tr>
                  <td style="font-size:0.78rem;color:var(--gris3)">${c.equipoId.replace(/_/g,' ')}</td>
                  <td class="jugador-nombre">${c.jugadorNombre}</td>
                  <td>${c.mes}</td>
                  <td style="font-size:0.75rem;color:var(--gris3)">${formatFecha(c.fecha)}</td>
                  <td>${estadoBadge(c.estado)}</td>
                  <td>${c.obsAdmin?`<span class="obs-tag" title="${c.obsAdmin}">${c.obsAdmin}</span>`:'â€”'}</td>
                  <td>
                    <div class="btn-actions">
                      <button class="btn-sm btn-ver" onclick="abrirModalVer('${c.id}')">ğŸ‘ Ver</button>
                      ${c.estado !== 'Aprobado' ? `<button class="btn-sm btn-aprobar" onclick="aprobarComprobante('${c.id}')">âœ…</button>` : ''}
                      ${c.estado !== 'Rechazado' ? `<button class="btn-sm btn-rechazar" onclick="abrirModalRechazar('${c.id}','${c.jugadorNombre.replace(/'/g,"\\'")}','${c.mes}','${c.equipoId}')">âŒ</button>` : ''}
                    </div>
                  </td>
                </tr>`).join('')}
            </tbody>
          </table>
        </div>
        ${renderPaginacion(comp.length)}`}
    </div>`;
}

async function renderPorEquipo() {
  const cnt = document.getElementById('main-content');
  cnt.innerHTML = `
    <div class="card">
      <div class="card-title">âš½ Ver comprobantes por equipo</div>
      <div class="form-group" style="max-width:300px">
        <label>SeleccionÃ¡ un equipo</label>
        <select id="sel-equipo-admin" onchange="cargarEquipoAdmin(this.value)">
          <option value="">ElegÃ­ un equipo...</option>
          ${EQUIPOS_FALLBACK.map(e=>`<option value="${e.id}">${e.nombre}</option>`).join('')}
        </select>
      </div>
      <div id="equipo-admin-content"></div>
    </div>`;
}

async function cargarEquipoAdmin(equipoId) {
  if (!equipoId) return;
  const div = document.getElementById('equipo-admin-content');
  div.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  try {
    const [dj, dc] = await Promise.all([
      api('getJugadores', {equipoId}),
      api('getComprobantes', {equipoId})
    ]);
    const jugadores = dj.ok ? dj.jugadores : [];
    const comps = dc.ok ? dc.comprobantes : [];

    div.innerHTML = `
      <div class="mes-selector" style="margin:14px 0">
        <label>Mes:</label>
        <select id="mes-equipo-admin" onchange="actualizarTablaEquipoAdmin()" style="padding:8px 14px;border:1.5px solid var(--gris1);border-radius:8px;font-family:'Sora',sans-serif">
          ${CONFIG.MESES.map(m=>`<option ${m===APP.filtroMes?'selected':''}>${m}</option>`).join('')}
        </select>
      </div>
      <div id="tabla-equipo-admin"></div>`;

    // Guardar datos para la tabla
    window._adminEquipoData = { jugadores, comps };
    actualizarTablaEquipoAdmin();
  } catch(e) {
    div.innerHTML = `<div class="empty">Error: ${e.message}</div>`;
  }
}

function actualizarTablaEquipoAdmin() {
  const mes = document.getElementById('mes-equipo-admin')?.value || APP.filtroMes;
  const { jugadores, comps } = window._adminEquipoData || { jugadores:[], comps:[] };
  const div = document.getElementById('tabla-equipo-admin');
  if (!div) return;

  div.innerHTML = `
    <div class="tabla-wrapper">
      <table>
        <thead><tr><th>#</th><th>Jugador</th><th>Estado</th><th>ObservaciÃ³n</th><th>Acciones</th></tr></thead>
        <tbody>
          ${jugadores.map((j,i) => {
            const c = comps.find(c => c.jugadorId == j.id && c.mes === mes);
            let estadoHtml = `<span class="estado-badge estado-sin-cargar">Sin cargar</span>`;
            let accionHtml = 'â€”';
            if (c) {
              estadoHtml = estadoBadge(c.estado);
              accionHtml = `
                <div class="btn-actions">
                  <button class="btn-sm btn-ver" onclick="abrirModalVer('${c.id}')">ğŸ‘ Ver</button>
                  ${c.estado !== 'Aprobado' ? `<button class="btn-sm btn-aprobar" onclick="aprobarComprobante('${c.id}')">âœ…</button>` : ''}
                  ${c.estado !== 'Rechazado' ? `<button class="btn-sm btn-rechazar" onclick="abrirModalRechazar('${c.id}','${j.nombre.replace(/'/g,"\\'")}','${mes}','')">âŒ</button>` : ''}
                </div>`;
            }
            return `
              <tr>
                <td style="color:var(--gris2);font-family:'JetBrains Mono',monospace;font-size:0.75rem">${i+1}</td>
                <td class="jugador-nombre">${j.nombre}
                  ${j.mas35?'<span class="badge-mas35" style="margin-left:4px">+35</span>':''}
                  ${j.ic?'<span class="badge-ic" style="margin-left:4px">IC</span>':''}
                </td>
                <td>${estadoHtml}</td>
                <td>${c?.obsAdmin?`<span class="obs-tag" title="${c.obsAdmin}">${c.obsAdmin}</span>`:'â€”'}</td>
                <td>${accionHtml}</td>
              </tr>`;
          }).join('')}
        </tbody>
      </table>
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODALES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function abrirModalCargar(jugadorId, jugadorNombre, mes, comprobanteIdRechazado, obsRechazo) {
  APP.modalJugadorId = jugadorId;
  APP.modalJugadorNombre = jugadorNombre;
  APP.modalComprobanteId = comprobanteIdRechazado;
  APP.archivoSeleccionado = null;

  document.getElementById('mc-jugador').textContent = jugadorNombre;
  document.getElementById('mc-equipo').textContent  = APP.equipo?.nombre || '';
  document.getElementById('mc-mes').textContent     = mes;
  document.getElementById('mc-obs').value = '';
  document.getElementById('modal-cargar-title').textContent =
    comprobanteIdRechazado ? 'ğŸ”„ Reintentar Comprobante' : 'ğŸ“¤ Cargar Comprobante';

  const obsDiv = document.getElementById('obs-rechazo-prev');
  if (obsRechazo) {
    obsDiv.style.display = '';
    document.getElementById('obs-rechazo-texto').textContent = obsRechazo;
  } else {
    obsDiv.style.display = 'none';
  }

  removeFile();
  abrirModal('modal-cargar');
}

function abrirModalRechazar(comprobanteId, jugadorNombre, mes, equipoId) {
  APP.modalComprobanteId = comprobanteId;
  document.getElementById('rech-jugador').textContent = jugadorNombre;
  document.getElementById('rech-mes').textContent     = mes;
  document.getElementById('rech-equipo').textContent  = equipoId.replace(/_/g,' ');
  document.getElementById('rech-obs').value = '';
  abrirModal('modal-rechazar');
}

async function abrirModalVer(comprobanteId) {
  const body = document.getElementById('modal-ver-body');
  const footer = document.getElementById('modal-ver-footer');
  body.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  abrirModal('modal-ver');

  try {
    const data = await api('getComprobante', { id: comprobanteId });
    if (!data.ok) throw new Error(data.msg);
    const c = data.comprobante;

    body.innerHTML = `
      <div class="modal-info">
        <div class="modal-info-row"><span>Jugador</span><span>${c.jugadorNombre}</span></div>
        <div class="modal-info-row"><span>Equipo</span><span>${c.equipoId.replace(/_/g,' ')}</span></div>
        <div class="modal-info-row"><span>Mes</span><span>${c.mes}</span></div>
        <div class="modal-info-row"><span>Fecha</span><span>${formatFecha(c.fecha)}</span></div>
        <div class="modal-info-row"><span>Estado</span><span>${estadoBadge(c.estado)}</span></div>
        ${c.obsAdmin?`<div class="modal-info-row"><span>Obs. Admin</span><span style="color:var(--rojo)">${c.obsAdmin}</span></div>`:''}
        ${c.obsUsuario?`<div class="modal-info-row"><span>Obs. Delegado</span><span>${c.obsUsuario}</span></div>`:''}
      </div>
      ${c.archivoB64
        ? (c.esImagen
          ? `<img src="data:${c.mimeType};base64,${c.archivoB64}" class="comprobante-preview" alt="Comprobante" style="max-width:100%;border-radius:8px;margin-top:12px;display:block">`
          : `<embed src="data:application/pdf;base64,${c.archivoB64}" type="application/pdf" width="100%" height="420px" style="border-radius:8px;margin-top:12px;display:block">
             <p style="font-size:0.78rem;color:var(--gris3);margin-top:6px;text-align:center">Si no se visualiza el PDF, usÃ¡ el botÃ³n Descargar â†“</p>`)
        : '<div class="empty" style="padding:20px">Sin archivo disponible</div>'}`;

    // BotÃ³n de descarga siempre visible
    if (c.urlDescarga) {
      body.innerHTML += `<div style="margin-top:8px;text-align:right"><a href="${c.urlDescarga}" target="_blank" style="font-size:0.8rem;color:var(--azul2)">â¬‡ Descargar archivo</a></div>`;
    }
    footer.innerHTML = `
      <button class="btn-sm btn-ver" onclick="cerrarModal('modal-ver')">Cerrar</button>
      ${APP.rol==='admin' && c.estado!=='Aprobado'
        ? `<button class="btn-sm btn-aprobar" onclick="aprobarComprobante('${comprobanteId}');cerrarModal('modal-ver')">âœ… Aprobar</button>`:''}
      ${APP.rol==='admin' && c.estado!=='Rechazado'
        ? `<button class="btn-sm btn-rechazar" onclick="cerrarModal('modal-ver');abrirModalRechazar('${comprobanteId}','${c.jugadorNombre.replace(/'/g,"\\'")}','${c.mes}','${c.equipoId}')">âŒ Rechazar</button>`:''}`;
  } catch(e) {
    body.innerHTML = `<div class="empty">Error al cargar: ${e.message}</div>`;
  }
}

function abrirModal(id) {
  document.getElementById(id).classList.add('open');
  document.getElementById(id).style.display = 'flex';
}
function cerrarModal(id) {
  const el = document.getElementById(id);
  el.classList.remove('open');
  el.style.display = 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UPLOAD DE ARCHIVO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleFile(input) {
  const file = input.files[0];
  if (!file) return;
  if (file.size > 10 * 1024 * 1024) {
    showToast('El archivo no puede superar 10MB', 'error'); return;
  }
  APP.archivoSeleccionado = file;
  const prev = document.getElementById('upload-preview');
  prev.style.display = 'flex';
  document.getElementById('prev-icon').textContent = file.type.includes('pdf') ? 'ğŸ“„' : 'ğŸ–¼ï¸';
  document.getElementById('prev-name').textContent = file.name;
  document.getElementById('prev-size').textContent = formatSize(file.size);
  document.getElementById('upload-zone').style.display = 'none';
}

function removeFile() {
  APP.archivoSeleccionado = null;
  document.getElementById('upload-preview').style.display = 'none';
  document.getElementById('upload-zone').style.display = '';
  document.getElementById('file-input').value = '';
}

async function confirmarCarga() {
  if (!APP.archivoSeleccionado) {
    showToast('SeleccionÃ¡ un archivo primero', 'error'); return;
  }

  const btn = document.getElementById('btn-confirmar-carga');
  btn.disabled = true; btn.textContent = 'Subiendo...';

  try {
    // Convertir archivo a base64
    const base64 = await fileToBase64(APP.archivoSeleccionado);
    const obs = document.getElementById('mc-obs').value;
    const mes = document.getElementById('mc-mes').textContent;

    const data = await apiPost('cargarComprobante', {
      equipoId:    APP.equipo.id,
      jugadorId:   APP.modalJugadorId,
      jugadorNombre: APP.modalJugadorNombre,
      mes,
      archivo:     base64,
      nombreArchivo: APP.archivoSeleccionado.name,
      tipoArchivo: APP.archivoSeleccionado.type,
      obsUsuario:  obs,
      reemplazaId: APP.modalComprobanteId || ''
    });

    if (data.ok) {
      cerrarModal('modal-cargar');
      showToast('Â¡Comprobante cargado correctamente!', 'success');
      renderDelegado();
    } else {
      throw new Error(data.msg || 'Error al cargar');
    }
  } catch(e) {
    showToast('Error: ' + e.message, 'error');
  }
  btn.disabled = false; btn.textContent = 'Cargar comprobante';
}

async function aprobarComprobante(comprobanteId) {
  try {
    const data = await api('aprobar', { id: comprobanteId });
    if (data.ok) {
      showToast('Comprobante aprobado âœ…', 'success');
      renderTodosComprobantes();
    } else throw new Error(data.msg);
  } catch(e) {
    showToast('Error: ' + e.message, 'error');
  }
}

async function confirmarRechazo() {
  const obs = document.getElementById('rech-obs').value.trim();
  if (!obs) { showToast('IngresÃ¡ el motivo del rechazo', 'error'); return; }

  const btn = document.querySelector('#modal-rechazar .btn-rechazar');
  btn.disabled = true; btn.textContent = 'Rechazando...';

  try {
    const data = await api('rechazar', { id: APP.modalComprobanteId, obs });
    if (data.ok) {
      cerrarModal('modal-rechazar');
      showToast('Comprobante rechazado', 'info');
      if (APP.rol === 'admin') renderTodosComprobantes();
      else renderDelegado();
    } else throw new Error(data.msg);
  } catch(e) {
    showToast('Error: ' + e.message, 'error');
  }
  btn.disabled = false; btn.textContent = 'Rechazar';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function estadoBadge(estado) {
  const map = {
    'Aprobado':  '<span class="estado-badge estado-aprobado">âœ… Aprobado</span>',
    'Rechazado': '<span class="estado-badge estado-rechazado">âŒ Rechazado</span>',
    'Pendiente': '<span class="estado-badge estado-pendiente">â³ Pendiente</span>',
  };
  return map[estado] || `<span class="estado-badge estado-pendiente">â³ ${estado||'Pendiente'}</span>`;
}

function formatFecha(str) {
  if (!str) return 'â€”';
  const d = new Date(str);
  if (isNaN(d)) return str;
  return d.toLocaleDateString('es-AR', {day:'2-digit',month:'2-digit',year:'2-digit',hour:'2-digit',minute:'2-digit'});
}

function formatSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024*1024) return (bytes/1024).toFixed(0) + ' KB';
  return (bytes/1024/1024).toFixed(1) + ' MB';
}

function fileToBase64(file) {
  return new Promise((res, rej) => {
    const r = new FileReader();
    r.onload = () => res(r.result.split(',')[1]);
    r.onerror = rej;
    r.readAsDataURL(file);
  });
}

function renderPaginacion(total) {
  const paginas = Math.ceil(total / APP.porPagina);
  if (paginas <= 1) return '';
  let html = '<div class="pagination">';
  for (let i = 1; i <= paginas; i++) {
    html += `<button class="page-btn ${i===APP.paginaActual?'active':''}"
      onclick="APP.paginaActual=${i}; renderListaAdmin(document.getElementById('main-content'))">${i}</button>`;
  }
  return html + '</div>';
}

let toastTimeout;
function showToast(msg, tipo = 'info') {
  const t = document.getElementById('toast');
  const icons = { success:'âœ…', error:'âŒ', info:'â„¹ï¸' };
  t.innerHTML = `<span>${icons[tipo]||''}</span><span>${msg}</span>`;
  t.className = `toast ${tipo} show`;
  clearTimeout(toastTimeout);
  toastTimeout = setTimeout(() => t.classList.remove('show'), 4000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HABILITACIONES (pestaÃ±a delegado)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderHabilitaciones() {
  const cnt = document.getElementById('main-content');
  cnt.innerHTML = '<div class="loading"><div class="spinner"></div> Cargando habilitaciones...</div>';
  try {
    const data = await api('getHabilitaciones', { equipoId: APP.equipo.id });
    if (!data.ok) throw new Error(data.msg);
    const { jugadores, mesActual, mesAnterior } = data;

    const habilitados = jugadores.filter(j => j.estado === 'Habilitado').length;
    const iAdmin      = jugadores.filter(j => j.estado === 'I. Administrativa').length;
    const iMedica     = jugadores.filter(j => j.estado === 'I. Medica' || j.estado === 'I. MÃ©dica').length;
    const iDeportiva  = jugadores.filter(j => j.estado === 'I. Deportiva').length;

    const estadoColor = {
      'Habilitado':        { bg:'#dcfce7', color:'#15803d', icono:'âœ…' },
      'I. Administrativa': { bg:'#fef9c3', color:'#854d0e', icono:'ğŸ’°' },
      'I. Medica':         { bg:'#fee2e2', color:'#b91c1c', icono:'ğŸ¥' },
      'I. MÃ©dica':         { bg:'#fee2e2', color:'#b91c1c', icono:'ğŸ¥' },
      'I. Deportiva':      { bg:'#ffe4e6', color:'#9f1239', icono:'ğŸš«' },
    };

    cnt.innerHTML = `
      <div class="equipo-header">
        <div>
          <div class="equipo-nombre">${APP.equipo.nombre} â€” Estado del plantel</div>
          <div class="equipo-cat">Ref. mes: <strong>${mesActual}</strong> (tambiÃ©n acepta ${mesAnterior})</div>
          <div class="equipo-stats">
            <div class="stat"><div class="stat-num" style="color:#86efac">${habilitados}</div><div class="stat-label">Habilitados</div></div>
            <div class="stat"><div class="stat-num" style="color:#fde047">${iAdmin}</div><div class="stat-label">I. Adm.</div></div>
            <div class="stat"><div class="stat-num" style="color:#fca5a5">${iMedica}</div><div class="stat-label">I. MÃ©d.</div></div>
            <div class="stat"><div class="stat-num" style="color:#f9a8d4">${iDeportiva}</div><div class="stat-label">I. Dep.</div></div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ… Habilitaciones del plantel</div>
        <div class="tabla-wrapper">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Jugador</th>
                <th>Estado</th>
                <th>Detalle</th>
              </tr>
            </thead>
            <tbody>
              ${jugadores.map((j,i) => {
                const est = estadoColor[j.estado] || { bg:'#f3f4f6', color:'#374151', icono:'â“' };
                const badges = [
                  j.mas35 ? '<span class="badge-mas35">+35</span>' : '',
                  j.ic    ? '<span class="badge-ic">IC</span>'    : ''
                ].join('');
                return `
                  <tr>
                    <td style="color:var(--gris2);font-size:0.75rem;font-family:'JetBrains Mono',monospace">${String(i+1).padStart(2,'0')}</td>
                    <td>
                      <div class="jugador-nombre">${j.nombre}</div>
                      ${badges ? `<div class="jugador-badges">${badges}</div>` : ''}
                    </td>
                    <td>
                      <span style="display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:20px;font-size:0.78rem;font-weight:600;background:${est.bg};color:${est.color}">
                        ${est.icono} ${j.estado}
                      </span>
                    </td>
                    <td style="font-size:0.8rem;color:var(--gris3)">${j.detalle || 'â€”'}</td>
                  </tr>`;
              }).join('')}
            </tbody>
          </table>
        </div>
      </div>`;
  } catch(e) {
    cnt.innerHTML = `<div class="card"><div class="empty"><div class="empty-icon">âš ï¸</div>Error: ${e.message}</div></div>`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GESTIÃ“N DE JUGADORES (admin)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderGestionJugadores(equipoFiltro = '') {
  const cnt = document.getElementById('main-content');
  cnt.innerHTML = '<div class="loading"><div class="spinner"></div> Cargando jugadores...</div>';
  try {
    const [dataEq, dataJug] = await Promise.all([
      api('getEquipos'),
      api('getJugadoresAdmin', equipoFiltro ? { equipoId: equipoFiltro } : {}),
    ]);
    if (!dataEq.ok || !dataJug.ok) throw new Error(dataJug.msg || dataEq.msg);
    const equipos   = dataEq.equipos;
    const jugadores = dataJug.jugadores;

    // Agrupar por equipo
    const grupos = {};
    jugadores.forEach(j => {
      if (!grupos[j.equipoId]) grupos[j.equipoId] = [];
      grupos[j.equipoId].push(j);
    });

    const opEq = equipos.map(e => `<option value="${e.id}" ${e.id===equipoFiltro?'selected':''}>${e.nombre}</option>`).join('');

    cnt.innerHTML = `
      <div class="card">
        <div class="card-title">ğŸ‘¥ GestiÃ³n de Jugadores</div>
        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:16px">
          <select id="eq-filtro-jug" style="padding:8px 12px;border:1.5px solid var(--gris1);border-radius:8px;font-family:inherit;font-size:0.88rem"
            onchange="renderGestionJugadores(this.value)">
            <option value="">Todos los equipos</option>
            ${opEq}
          </select>
          <button class="btn-sm btn-aprobar" onclick="abrirModalAltaJugador()">â• Alta jugador</button>
        </div>

        ${Object.keys(grupos).length === 0
          ? '<div class="empty"><div class="empty-icon">ğŸ‘¥</div>No hay jugadores.</div>'
          : Object.entries(grupos).map(([eqId, jugs]) => {
              const eq = equipos.find(e => e.id === eqId) || { nombre: eqId };
              return `
                <div style="margin-bottom:24px">
                  <div style="font-weight:700;font-size:0.88rem;color:var(--azul);text-transform:uppercase;letter-spacing:0.04em;margin-bottom:8px;padding:6px 0;border-bottom:2px solid var(--gris1)">
                    âš½ ${eq.nombre} <span style="color:var(--gris3);font-weight:400;font-size:0.8rem">(${jugs.length} jugadores)</span>
                  </div>
                  <div class="tabla-wrapper">
                    <table>
                      <thead><tr><th>ID</th><th>Apellido y Nombres</th><th>+35</th><th>IC</th><th>Acciones</th></tr></thead>
                      <tbody>
                        ${jugs.map(j => `
                          <tr>
                            <td style="font-family:'JetBrains Mono',monospace;font-size:0.78rem;color:var(--gris3)">${j.id}</td>
                            <td class="jugador-nombre">${j.nombre}</td>
                            <td style="text-align:center">${j.mas35?'<span class="badge-mas35">+35</span>':''}</td>
                            <td style="text-align:center">${j.ic?'<span class="badge-ic">IC</span>':''}</td>
                            <td>
                              <div class="btn-actions">
                                <button class="btn-sm btn-ver" onclick="abrirModalEditarJugador('${j.id}','${j.nombre.replace(/'/g,"\\'")}','${j.equipoId}',${j.mas35},${j.ic})">âœï¸ Editar</button>
                                <button class="btn-sm btn-ver" onclick="abrirModalTraspaso('${j.id}','${j.nombre.replace(/'/g,"\\'")}','${j.equipoId}')">ğŸ”„ Traspasar</button>
                                <button class="btn-sm btn-rechazar" onclick="confirmarBajaJugador('${j.id}','${j.nombre.replace(/'/g,"\\'")}')">ğŸ—‘ Baja</button>
                              </div>
                            </td>
                          </tr>`).join('')}
                      </tbody>
                    </table>
                  </div>
                </div>`;
            }).join('')}
      </div>

      <!-- Modal Alta Jugador -->
      <div class="modal-overlay" id="modal-alta-jug" style="display:none">
        <div class="modal-card" style="max-width:420px">
          <div class="modal-header">
            <span class="modal-title">â• Alta de jugador</span>
            <button class="modal-close" onclick="cerrarModal('modal-alta-jug')">âœ•</button>
          </div>
          <div class="modal-body" style="padding:20px;display:flex;flex-direction:column;gap:14px">
            <div class="form-group">
              <label>Equipo</label>
              <select id="alta-equipo" style="width:100%;padding:10px;border:1.5px solid var(--gris1);border-radius:8px;font-family:inherit">
                <option value="">â€” SeleccionÃ¡ â€”</option>
                ${opEq}
              </select>
            </div>
            <div class="form-group">
              <label>Apellido y Nombres</label>
              <input id="alta-nombre" type="text" placeholder="GARCIA JUAN MARTIN" style="width:100%;padding:10px;border:1.5px solid var(--gris1);border-radius:8px;font-family:inherit;text-transform:uppercase">
            </div>
            <div style="display:flex;gap:16px">
              <label style="display:flex;align-items:center;gap:6px;font-size:0.88rem;cursor:pointer">
                <input type="checkbox" id="alta-mas35"> Mayor de 35
              </label>
              <label style="display:flex;align-items:center;gap:6px;font-size:0.88rem;cursor:pointer">
                <input type="checkbox" id="alta-ic"> IntercategorÃ­a
              </label>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn-sm btn-ver" onclick="cerrarModal('modal-alta-jug')">Cancelar</button>
            <button class="btn-sm btn-aprobar" id="btn-alta-jug" onclick="confirmarAltaJugador()">â• Dar de alta</button>
          </div>
        </div>
      </div>

      <!-- Modal Editar Jugador -->
      <div class="modal-overlay" id="modal-editar-jug" style="display:none">
        <div class="modal-card" style="max-width:420px">
          <div class="modal-header">
            <span class="modal-title">âœï¸ Editar jugador</span>
            <button class="modal-close" onclick="cerrarModal('modal-editar-jug')">âœ•</button>
          </div>
          <div class="modal-body" style="padding:20px;display:flex;flex-direction:column;gap:14px">
            <input type="hidden" id="edit-jug-id">
            <div class="form-group">
              <label>Apellido y Nombres</label>
              <input id="edit-jug-nombre" type="text" style="width:100%;padding:10px;border:1.5px solid var(--gris1);border-radius:8px;font-family:inherit;text-transform:uppercase">
            </div>
            <div style="display:flex;gap:16px">
              <label style="display:flex;align-items:center;gap:6px;font-size:0.88rem;cursor:pointer">
                <input type="checkbox" id="edit-jug-mas35"> Mayor de 35
              </label>
              <label style="display:flex;align-items:center;gap:6px;font-size:0.88rem;cursor:pointer">
                <input type="checkbox" id="edit-jug-ic"> IntercategorÃ­a
              </label>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn-sm btn-ver" onclick="cerrarModal('modal-editar-jug')">Cancelar</button>
            <button class="btn-sm btn-aprobar" onclick="confirmarEditarJugador()">ğŸ’¾ Guardar</button>
          </div>
        </div>
      </div>

      <!-- Modal Traspaso -->
      <div class="modal-overlay" id="modal-traspaso" style="display:none">
        <div class="modal-card" style="max-width:420px">
          <div class="modal-header">
            <span class="modal-title">ğŸ”„ Traspaso de jugador</span>
            <button class="modal-close" onclick="cerrarModal('modal-traspaso')">âœ•</button>
          </div>
          <div class="modal-body" style="padding:20px;display:flex;flex-direction:column;gap:14px">
            <input type="hidden" id="trasp-jug-id">
            <p id="trasp-jug-nombre" style="font-weight:600;color:var(--azul)"></p>
            <div class="form-group">
              <label>Equipo destino</label>
              <select id="trasp-equipo-dest" style="width:100%;padding:10px;border:1.5px solid var(--gris1);border-radius:8px;font-family:inherit">
                <option value="">â€” SeleccionÃ¡ â€”</option>
                ${opEq}
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn-sm btn-ver" onclick="cerrarModal('modal-traspaso')">Cancelar</button>
            <button class="btn-sm btn-aprobar" onclick="confirmarTraspaso()">ğŸ”„ Traspasar</button>
          </div>
        </div>
      </div>`;

  } catch(e) {
    cnt.innerHTML = `<div class="card"><div class="empty"><div class="empty-icon">âš ï¸</div>Error: ${e.message}</div></div>`;
  }
}

function abrirModalAltaJugador() {
  document.getElementById('alta-nombre').value = '';
  document.getElementById('alta-mas35').checked = false;
  document.getElementById('alta-ic').checked = false;
  abrirModal('modal-alta-jug');
}

async function confirmarAltaJugador() {
  const equipoId = document.getElementById('alta-equipo').value;
  const nombre   = document.getElementById('alta-nombre').value.trim();
  if (!equipoId) { showToast('SeleccionÃ¡ un equipo', 'error'); return; }
  if (!nombre)   { showToast('IngresÃ¡ el nombre del jugador', 'error'); return; }
  const btn = document.getElementById('btn-alta-jug');
  btn.disabled = true; btn.textContent = 'Guardando...';
  try {
    const data = await api('altaJugador', {
      equipoId, nombre,
      mas35: String(document.getElementById('alta-mas35').checked),
      ic:    String(document.getElementById('alta-ic').checked),
    });
    if (data.ok) {
      cerrarModal('modal-alta-jug');
      showToast('Jugador dado de alta âœ…', 'success');
      renderGestionJugadores(equipoId);
    } else throw new Error(data.msg);
  } catch(e) { showToast('Error: ' + e.message, 'error'); }
  btn.disabled = false; btn.textContent = 'â• Dar de alta';
}

function abrirModalEditarJugador(id, nombre, equipoId, mas35, ic) {
  document.getElementById('edit-jug-id').value     = id;
  document.getElementById('edit-jug-nombre').value = nombre;
  document.getElementById('edit-jug-mas35').checked = mas35 === true || mas35 === 'true';
  document.getElementById('edit-jug-ic').checked    = ic    === true || ic    === 'true';
  abrirModal('modal-editar-jug');
}

async function confirmarEditarJugador() {
  const jugadorId = document.getElementById('edit-jug-id').value;
  const nombre    = document.getElementById('edit-jug-nombre').value.trim();
  if (!nombre) { showToast('IngresÃ¡ el nombre', 'error'); return; }
  try {
    const data = await api('editarJugador', {
      jugadorId, nombre,
      mas35: String(document.getElementById('edit-jug-mas35').checked),
      ic:    String(document.getElementById('edit-jug-ic').checked),
    });
    if (data.ok) {
      cerrarModal('modal-editar-jug');
      showToast('Jugador actualizado âœ…', 'success');
      renderGestionJugadores();
    } else throw new Error(data.msg);
  } catch(e) { showToast('Error: ' + e.message, 'error'); }
}

function abrirModalTraspaso(id, nombre, equipoActual) {
  document.getElementById('trasp-jug-id').value    = id;
  document.getElementById('trasp-jug-nombre').textContent = nombre + ' (desde: ' + equipoActual.replace(/_/g,' ') + ')';
  abrirModal('modal-traspaso');
}

async function confirmarTraspaso() {
  const jugadorId    = document.getElementById('trasp-jug-id').value;
  const nuevoEquipoId = document.getElementById('trasp-equipo-dest').value;
  if (!nuevoEquipoId) { showToast('SeleccionÃ¡ el equipo destino', 'error'); return; }
  try {
    const data = await api('traspasarJugador', { jugadorId, nuevoEquipoId });
    if (data.ok) {
      cerrarModal('modal-traspaso');
      showToast('Traspaso realizado âœ…', 'success');
      renderGestionJugadores();
    } else throw new Error(data.msg);
  } catch(e) { showToast('Error: ' + e.message, 'error'); }
}

async function confirmarBajaJugador(jugadorId, nombre) {
  if (!confirm(`Â¿Dar de BAJA a ${nombre}? Esta acciÃ³n no se puede deshacer.`)) return;
  try {
    const data = await api('bajaJugador', { jugadorId });
    if (data.ok) {
      showToast('Jugador dado de baja âœ…', 'success');
      renderGestionJugadores();
    } else throw new Error(data.msg);
  } catch(e) { showToast('Error: ' + e.message, 'error'); }
}


async function renderPlanillas() {
  const cnt = document.getElementById('main-content');
  cnt.innerHTML = '<div class="loading"><div class="spinner"></div> Cargando fixture...</div>';

  try {
    const data = await api('getFixture');
    if (!data.ok) {
      cnt.innerHTML = `
        <div class="card">
          <div class="card-title">ğŸ“„ Planillas de Partido</div>
          <div class="empty" style="padding:32px 20px">
            <div class="empty-icon">âš ï¸</div>
            <p>${data.msg}</p>
            <p style="font-size:0.8rem;color:var(--gris3);margin-top:8px">
              CreÃ¡ una pestaÃ±a llamada <strong>"Fixture"</strong> en el Google Sheet con las columnas:<br>
              <code style="background:var(--gris0);padding:2px 6px;border-radius:4px;font-size:0.75rem">
                FechaNro | Torneo | CategorÃ­a | DÃ­a | Fecha | Hora | Cancha | Equipo Local | Equipo Visitante | Resultado | Observaciones
              </code>
            </p>
          </div>
        </div>`;
      return;
    }

    const partidos = data.partidos;
    if (!partidos.length) {
      cnt.innerHTML = `<div class="card"><div class="card-title">ğŸ“„ Planillas de Partido</div>
        <div class="empty"><div class="empty-icon">ğŸ“…</div>No hay partidos en el fixture.</div></div>`;
      return;
    }

    // Agrupar por FechaNro
    const grupos = {};
    partidos.forEach(p => {
      const g = p.fechaNro || 'Sin fecha';
      if (!grupos[g]) grupos[g] = [];
      grupos[g].push(p);
    });

    let html = `
      <div class="card">
        <div class="card-title">ğŸ“„ Planillas de Partido</div>
        <p style="font-size:0.82rem;color:var(--gris3);margin-bottom:16px">
          SeleccionÃ¡ un partido para generar la planilla con el estado de habilitaciÃ³n de cada jugador.
        </p>
        <div class="fixture-filtros">
          <select onchange="filtrarFixture(this.value)" id="filtro-fecha-nro">
            <option value="">Todas las fechas</option>
            ${Object.keys(grupos).map(g => `<option value="${g}">${g}</option>`).join('')}
          </select>
        </div>
        <div id="fixture-lista">`;

    Object.entries(grupos).forEach(([fechaNro, pts]) => {
      html += `<div class="fixture-grupo" data-fecha="${fechaNro}">
        <div class="fixture-grupo-titulo">${fechaNro} â€” ${pts[0].torneo || ''}</div>`;
      pts.forEach(p => {
        const catClass = (p.categoria||'').toLowerCase().includes('senior') ? 'cat-senior' : 'cat-libres';
        const pJson = JSON.stringify(p).replace(/"/g,'&quot;');
        html += `
          <div class="partido-card">
            <div class="partido-info">
              <div class="partido-titulo">
                ${p.local} <span style="color:var(--gris2);font-weight:400">vs</span> ${p.visitante}
                ${p.categoria ? `<span class="partido-cat ${catClass}">${p.categoria}</span>` : ''}
              </div>
              <div class="partido-detalle">
                ${p.fecha ? `<span>ğŸ“… ${p.fecha}</span>` : ''}
                ${p.hora  ? `<span>ğŸ• ${p.hora}</span>` : ''}
                ${p.cancha? `<span>ğŸŸ¢ Cancha ${p.cancha}</span>` : ''}
                ${p.obs   ? `<span style="color:var(--amarillo)">âš ï¸ ${p.obs}</span>` : ''}
              </div>
            </div>
            <button class="btn-planilla" onclick="generarPlanilla(${pJson.replace(/&quot;/g,"'")})" 
              id="btn-plan-${p.local.replace(/\s/g,'')}-${p.visitante.replace(/\s/g,'')}">
              ğŸ“„ Ver Planilla
            </button>
          </div>`;
      });
      html += '</div>';
    });

    html += '</div></div>';
    cnt.innerHTML = html;
  } catch(e) {
    cnt.innerHTML = `<div class="card"><div class="empty"><div class="empty-icon">âš ï¸</div>Error: ${e.message}</div></div>`;
  }
}

function filtrarFixture(fechaNro) {
  document.querySelectorAll('.fixture-grupo').forEach(g => {
    g.style.display = (!fechaNro || g.dataset.fecha === fechaNro) ? '' : 'none';
  });
}

async function generarPlanilla(partido) {
  const btnId = `btn-plan-${partido.local.replace(/\s/g,'')}-${partido.visitante.replace(/\s/g,'')}`;
  const btn = document.getElementById(btnId);
  if (btn) { btn.disabled = true; btn.textContent = 'â³ Cargando...'; }

  try {
    const data = await api('getPlanillaData', {
      local:     partido.local,
      visitante: partido.visitante,
      fechaNro:  partido.fechaNro,
      torneo:    partido.torneo,
      categoria: partido.categoria,
      fecha:     partido.fecha,
      hora:      partido.hora,
      cancha:    partido.cancha,
    });

    if (!data.ok) throw new Error(data.msg);
    abrirVentanaPlanilla(data, partido);
  } catch(e) {
    showToast('Error al generar planilla: ' + e.message, 'error');
  }

  if (btn) { btn.disabled = false; btn.textContent = 'ğŸ“„ Ver Planilla'; }
}

function abrirVentanaPlanilla(data, partido) {
  const { jugadoresLocal, jugadoresVisitante, mesActual } = data;

  function tablaJugadores(jugadores, equipoNombre, esLocal) {
    if (!jugadores.length) {
      return `<tr><td colspan="8" style="text-align:center;color:#888;font-style:italic;padding:12px">Sin jugadores registrados</td></tr>`;
    }
    return jugadores.map((j, i) => {
      const hab = j.estado === 'Habilitado';
      const prefijo = j.mas35 ? '+50 ' : '';
      const sufijo  = j.ic    ? ' [IC]'  : '';
      const estadoTxt = hab ? 'âœ“ Habilitado' : `âœ— ${j.estado}`;
      return `
        <tr>
          <td class="col-nro">${String(i+1).padStart(2,'0')}</td>
          <td class="col-nombre">${prefijo}<strong>${j.nombre}</strong>${sufijo}</td>
          <td class="col-estado ${hab ? 'hab' : 'inhab'}">${estadoTxt}</td>
          <td class="col-ch"></td>
          <td class="col-firma"></td>
          <td class="col-gol"></td>
          <td class="col-am"></td>
          <td class="col-roja"></td>
        </tr>`;
    }).join('');
  }

  const hoy = new Date().toLocaleDateString('es-AR');

  const html = `<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Planilla â€” ${partido.local} vs ${partido.visitante}</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: Arial, sans-serif; font-size: 10px; color: #000; background: #fff; }
  
  .page { width: 210mm; min-height: 297mm; padding: 10mm 10mm; page-break-after: always; }
  .page:last-child { page-break-after: auto; }

  /* Encabezado */
  .header-planilla {
    display: flex; align-items: center; justify-content: space-between;
    border-bottom: 3px solid #1a3a5c; padding-bottom: 8px; margin-bottom: 8px;
  }
  .header-logo {
    display: flex; align-items: center; gap: 8px;
  }
  .logo-box {
    width: 44px; height: 44px; background: #1a3a5c; border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    color: white; font-size: 22px; font-weight: bold;
  }
  .header-club { font-size: 11px; color: #1a3a5c; }
  .header-club strong { font-size: 14px; display: block; font-weight: 900; }
  .header-titulo { text-align: center; font-size: 13px; font-weight: 700; color: #1a3a5c; text-transform: uppercase; letter-spacing: 1px; }
  
  /* Info del partido */
  .partido-info {
    background: #1a3a5c; color: white;
    border-radius: 6px; padding: 8px 14px;
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 10px; flex-wrap: wrap; gap: 6px;
  }
  .partido-info .pi-item { text-align: center; }
  .partido-info .pi-label { font-size: 8px; text-transform: uppercase; opacity: 0.7; letter-spacing: 0.5px; }
  .partido-info .pi-valor { font-size: 12px; font-weight: 700; }
  .partido-equipos { font-size: 15px; font-weight: 900; text-align: center; flex: 1; }
  .partido-equipos .vs { font-size: 10px; font-weight: 400; opacity: 0.7; margin: 0 6px; }

  /* Tabla de jugadores */
  .equipo-titulo {
    background: #1a3a5c; color: white;
    padding: 6px 12px; font-weight: 700; font-size: 11px;
    border-radius: 4px 4px 0 0; margin-top: 10px;
    text-transform: uppercase; letter-spacing: 0.5px;
  }
  table { width: 100%; border-collapse: collapse; font-size: 9.5px; }
  thead tr { background: #e8eef5; }
  th {
    padding: 5px 6px; text-align: left; font-weight: 700;
    font-size: 8px; text-transform: uppercase; letter-spacing: 0.3px;
    border: 0.5px solid #ccc; color: #333;
  }
  td { padding: 4px 6px; border: 0.5px solid #ddd; vertical-align: middle; }
  tr:nth-child(even) td { background: #f8f9fb; }
  
  .col-nro   { width: 26px; text-align: center; color: #666; font-size: 9px; }
  .col-nombre{ min-width: 160px; }
  .col-estado{ width: 110px; font-size: 9px; }
  .col-ch    { width: 36px; }
  .col-firma { width: 80px; }
  .col-gol   { width: 30px; text-align: center; }
  .col-am    { width: 36px; text-align: center; }
  .col-roja  { width: 30px; text-align: center; }
  
  .hab   { color: #15803d; font-weight: 600; }
  .inhab { color: #b91c1c; font-weight: 700; }

  /* Pie de planilla */
  .pie {
    margin-top: 18px; border-top: 1px solid #ccc; padding-top: 12px;
    display: flex; justify-content: space-between; gap: 20px;
  }
  .pie-campo { flex: 1; }
  .pie-campo label { font-size: 8px; text-transform: uppercase; color: #666; letter-spacing: 0.3px; display: block; margin-bottom: 20px; }
  .pie-linea { border-bottom: 1px solid #999; height: 1px; margin-bottom: 4px; }
  .pie-campo span { font-size: 7.5px; color: #888; }

  .mes-badge {
    display: inline-block; background: #1d7a4e; color: white;
    padding: 2px 8px; border-radius: 10px; font-size: 8px; font-weight: 700;
    margin-left: 6px; vertical-align: middle;
  }

  @media print {
    body { margin: 0; }
    .no-print { display: none !important; }
    .page { padding: 8mm; }
  }

  /* Botones pantalla */
  .toolbar {
    position: fixed; top: 0; left: 0; right: 0;
    background: #1a3a5c; padding: 10px 20px;
    display: flex; gap: 10px; align-items: center;
    z-index: 999; box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  }
  .toolbar button {
    padding: 8px 18px; border: none; border-radius: 6px;
    font-family: Arial; font-size: 13px; font-weight: 700;
    cursor: pointer; transition: all 0.15s;
  }
  .btn-imprimir { background: #22c55e; color: white; }
  .btn-imprimir:hover { background: #16a34a; }
  .btn-cerrar   { background: rgba(255,255,255,0.15); color: white; border: 1px solid rgba(255,255,255,0.3) !important; }
  .btn-cerrar:hover { background: rgba(255,255,255,0.25); }
  .toolbar-title { color: white; font-size: 13px; font-weight: 600; flex: 1; }
  body { padding-top: 52px; }
</style>
</head>
<body>

<div class="toolbar no-print">
  <button class="btn-imprimir" onclick="window.print()">ğŸ–¨ï¸ Imprimir / Guardar PDF</button>
  <span class="toolbar-title">${partido.local} vs ${partido.visitante} â€” ${partido.fechaNro} â€” ${partido.categoria || ''}</span>
  <button class="btn-cerrar" onclick="window.close()">âœ• Cerrar</button>
</div>

<!-- PÃGINA 1: Equipo Local -->
<div class="page">
  <div class="header-planilla">
    <div class="header-logo">
      <div class="logo-box">âš½</div>
      <div class="header-club">
        <strong>CDP</strong>
        Club de Profesionales
      </div>
    </div>
    <div class="header-titulo">Torneo ${partido.torneo || 'CDP'}</div>
    <div style="text-align:right; font-size:9px; color:#555">
      ${partido.fechaNro}<br>
      Generada: ${hoy}<br>
      Mes ref.: <strong>${mesActual}</strong>
    </div>
  </div>

  <div class="partido-info">
    <div class="pi-item"><div class="pi-label">CategorÃ­a</div><div class="pi-valor">${partido.categoria || 'â€”'}</div></div>
    <div class="partido-equipos">${partido.local} <span class="vs">vs</span> ${partido.visitante}</div>
    <div class="pi-item"><div class="pi-label">Fecha</div><div class="pi-valor">${partido.fecha || 'â€”'}</div></div>
    <div class="pi-item"><div class="pi-label">Hora</div><div class="pi-valor">${partido.hora || 'â€”'}</div></div>
    <div class="pi-item"><div class="pi-label">Cancha</div><div class="pi-valor">${partido.cancha || 'â€”'}</div></div>
  </div>

  <div class="equipo-titulo">
    ${partido.local}
    <span class="mes-badge">Ref. ${mesActual}</span>
  </div>
  <table>
    <thead>
      <tr>
        <th class="col-nro">Nro</th>
        <th class="col-nombre">Apellido y Nombres</th>
        <th class="col-estado">Estado</th>
        <th class="col-ch">Camiseta</th>
        <th class="col-firma">Firma</th>
        <th class="col-gol">Gol</th>
        <th class="col-am">Amarillas</th>
        <th class="col-roja">Roja</th>
      </tr>
    </thead>
    <tbody>
      ${tablaJugadores(jugadoresLocal, partido.local, true)}
    </tbody>
  </table>

  <div class="pie">
    <div class="pie-campo">
      <label>Ãrbitro</label>
      <div class="pie-linea"></div>
      <span>Firma y aclaraciÃ³n</span>
    </div>
    <div class="pie-campo">
      <label>Asistente 1</label>
      <div class="pie-linea"></div>
    </div>
    <div class="pie-campo">
      <label>Asistente 2</label>
      <div class="pie-linea"></div>
    </div>
    <div class="pie-campo">
      <label>Resultado final: ${partido.local} ___ â€” ___ ${partido.visitante}</label>
      <div class="pie-linea"></div>
    </div>
  </div>
  <div class="pie" style="margin-top:10px">
    <div class="pie-campo">
      <label>Firma responsable ${partido.local}</label>
      <div class="pie-linea"></div>
    </div>
    <div class="pie-campo">
      <label>Firma responsable ${partido.visitante}</label>
      <div class="pie-linea"></div>
    </div>
  </div>
</div>

<!-- PÃGINA 2: Equipo Visitante -->
<div class="page">
  <div class="header-planilla">
    <div class="header-logo">
      <div class="logo-box">âš½</div>
      <div class="header-club">
        <strong>CDP</strong>
        Club de Profesionales
      </div>
    </div>
    <div class="header-titulo">Torneo ${partido.torneo || 'CDP'}</div>
    <div style="text-align:right; font-size:9px; color:#555">
      ${partido.fechaNro}<br>
      Generada: ${hoy}<br>
      Mes ref.: <strong>${mesActual}</strong>
    </div>
  </div>

  <div class="partido-info">
    <div class="pi-item"><div class="pi-label">CategorÃ­a</div><div class="pi-valor">${partido.categoria || 'â€”'}</div></div>
    <div class="partido-equipos">${partido.visitante} <span class="vs">vs</span> ${partido.local}</div>
    <div class="pi-item"><div class="pi-label">Fecha</div><div class="pi-valor">${partido.fecha || 'â€”'}</div></div>
    <div class="pi-item"><div class="pi-label">Hora</div><div class="pi-valor">${partido.hora || 'â€”'}</div></div>
    <div class="pi-item"><div class="pi-label">Cancha</div><div class="pi-valor">${partido.cancha || 'â€”'}</div></div>
  </div>

  <div class="equipo-titulo">
    ${partido.visitante}
    <span class="mes-badge">Ref. ${mesActual}</span>
  </div>
  <table>
    <thead>
      <tr>
        <th class="col-nro">Nro</th>
        <th class="col-nombre">Apellido y Nombres</th>
        <th class="col-estado">Estado</th>
        <th class="col-ch">Camiseta</th>
        <th class="col-firma">Firma</th>
        <th class="col-gol">Gol</th>
        <th class="col-am">Amarillas</th>
        <th class="col-roja">Roja</th>
      </tr>
    </thead>
    <tbody>
      ${tablaJugadores(jugadoresVisitante, partido.visitante, false)}
    </tbody>
  </table>

  <div class="pie">
    <div class="pie-campo">
      <label>Ãrbitro</label>
      <div class="pie-linea"></div>
      <span>Firma y aclaraciÃ³n</span>
    </div>
    <div class="pie-campo">
      <label>Asistente 1</label>
      <div class="pie-linea"></div>
    </div>
    <div class="pie-campo">
      <label>Asistente 2</label>
      <div class="pie-linea"></div>
    </div>
    <div class="pie-campo">
      <label>Resultado final: ${partido.visitante} ___ â€” ___ ${partido.local}</label>
      <div class="pie-linea"></div>
    </div>
  </div>
  <div class="pie" style="margin-top:10px">
    <div class="pie-campo">
      <label>Firma responsable ${partido.visitante}</label>
      <div class="pie-linea"></div>
    </div>
    <div class="pie-campo">
      <label>Firma responsable ${partido.local}</label>
      <div class="pie-linea"></div>
    </div>
  </div>
</div>

</body>
</html>`;

  const win = window.open('', '_blank', 'width=900,height=700,scrollbars=yes');
  if (!win) {
    showToast('El navegador bloqueÃ³ la ventana emergente. Permitila para ver la planilla.', 'error');
    return;
  }
  win.document.write(html);
  win.document.close();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
cargarEquiposSelect();

// Drag & drop en upload zone
document.getElementById('upload-zone')?.addEventListener('dragover', e => {
  e.preventDefault();
  e.currentTarget.classList.add('drag-over');
});
document.getElementById('upload-zone')?.addEventListener('dragleave', e => {
  e.currentTarget.classList.remove('drag-over');
});
document.getElementById('upload-zone')?.addEventListener('drop', e => {
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (file) {
    const input = document.getElementById('file-input');
    const dt = new DataTransfer();
    dt.items.add(file);
    input.files = dt.files;
    handleFile(input);
  }
});
</script>
</body>
</html>
